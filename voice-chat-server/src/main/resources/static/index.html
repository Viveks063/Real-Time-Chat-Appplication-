<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring Boot Chat</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #2c2f33; color: #ffffff; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .chat-container { width: 400px; height: 600px; background-color: #23272a; border-radius: 8px; display: flex; flex-direction: column; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
        .messages { flex-grow: 1; padding: 15px; overflow-y: auto; border-bottom: 1px solid #40444b; }
        .message { margin-bottom: 10px; }
        .message span { background-color: #7289da; padding: 8px 12px; border-radius: 18px; display: inline-block; }
        .controls { display: flex; padding: 10px; }
        input { flex-grow: 1; padding: 10px; border: none; border-radius: 5px; background-color: #40444b; color: #ffffff; outline: none; }
        button { padding: 10px 15px; border: none; border-radius: 5px; background-color: #7289da; color: #ffffff; cursor: pointer; margin-left: 10px; }
        button:hover { background-color: #677bc4; }
        .join-controls { padding: 15px; display: flex; flex-direction: column; gap: 10px; }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="join-controls">
        <input type="text" id="usernameInput" placeholder="Enter your username...">
        <input type="text" id="roomInput" placeholder="Enter room name...">
        <button id="joinButton">Join Room</button>
    </div>
    <div class="messages" id="messages"></div>
    <div class="controls">
        <input type="text" id="messageInput" placeholder="Type a message..." disabled>
        <button id="sendButton" disabled>Send</button>
    </div>
</div>

<script>
    // Get references to all the HTML elements we need
    const usernameInput = document.getElementById('usernameInput');
    const roomInput = document.getElementById('roomInput');
    const joinButton = document.getElementById('joinButton');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const messagesDiv = document.getElementById('messages');

    let websocket; // This variable will hold our WebSocket connection

    // --- 1. Event Listener for the "Join" button ---
    joinButton.addEventListener('click', () => {
        const username = usernameInput.value;
        const room = roomInput.value;

        if (!username || !room) {
            alert('Username and room cannot be empty!');
            return;
        }

        // Create the WebSocket URL. Note: 'ws' for http, 'wss' for https
        const wsUri = `ws://${window.location.host}/voice/${room}`;
        
        // Create the WebSocket connection
        websocket = new WebSocket(wsUri);

        // --- 2. Define what happens on WebSocket events ---
        
        // This runs when the connection is successfully opened
        websocket.onopen = (event) => {
            console.log('Connected to server!');
            messagesDiv.innerHTML += `<div class="message"><i>--- You have joined the room: ${room} ---</i></div>`;
            // Enable the message input and send button
            messageInput.disabled = false;
            sendButton.disabled = false;
            joinButton.textContent = 'Leave'; // Change button to "Leave"
        };

        // This runs every time a message is received from the server
        websocket.onmessage = (event) => {
            const message = event.data;
            messagesDiv.innerHTML += `<div class="message"><span>${message}</span></div>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight; // Auto-scroll to the bottom
        };

        // This runs when the connection is closed
        websocket.onclose = (event) => {
            console.log('Disconnected from server.');
            messagesDiv.innerHTML += `<div class="message"><i>--- You have left the room ---</i></div>`;
            // Disable the message input and send button
            messageInput.disabled = true;
            sendButton.disabled = true;
            joinButton.textContent = 'Join Room';
        };

        // This runs if there's an error
        websocket.onerror = (error) => {
            console.error('WebSocket Error:', error);
        };
    });

    // --- 3. Event Listener for the "Send" button ---
    sendButton.addEventListener('click', () => {
        const message = messageInput.value;
        const username = usernameInput.value;
        if (message) {
            // Create the full message text
            const fullMessage = `${username}: ${message}`;
            
            // Send the message to the server for everyone else
            websocket.send(fullMessage);
            
            // --- THIS IS THE NEW PART ---
            // Display your own message immediately in your own chat window
            messagesDiv.innerHTML += `<div class="message"><span>${fullMessage}</span></div>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight; // Auto-scroll
            // --------------------------

            messageInput.value = ''; // Clear the input box
        }
    });
    
    // Allow sending by pressing Enter
    messageInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            // Trigger the click event on the send button
            sendButton.click();
        }
    });
</script>
</body>
</html>